---
title: "Group 6 R Project"
author: "Beau Barber"
date: "9/18/2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Install tidytuesday package
```{r}
install.packages("tidytuesdayR", repos = "http://cran.us.r-project.org") #in order install.package to be in code you might have to include repo="repo source"
install.packages("olsrr", repos = "http://cran.us.r-project.org")
install.packages("onewaytests", repos = "http://cran.us.r-project.org")
```



#Pull Data

```{r}
rainfall <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-01-07/rainfall.csv')
temperature <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-01-07/temperature.csv')


head(rainfall)
head(temperature)
```
## Load all necessary libraries
Be sure to install these packages on your computer if you have never done so before (ex: install.packages("lsmeans"))
```{r}
library(lmerTest)
library(lsmeans)
library(multcomp)
library(multcompView)
library(tidyverse)
library(lawstat)
library(doBy)
library(ggplot2)
library(dplyr)
library(patchwork)
library(olsrr)
library(onewaytests)
```

Add a column to rainfall data so the date is all in one column as one date string
```{r}
rainfall$date <- as.Date(paste(rainfall$year,"-",rainfall$month,"-",rainfall$day, sep = ""))
```

Filter the rainfall and temperature data so we are only working with variables from Jan 1967 to Dec 2018
```{r}
# Change the capitalization of city_names in temperature to match rainfall city_name case
temperature$city_name <- gsub("BRISBANE","Brisbane", temperature$city_name)
temperature$city_name <- gsub("CANBERRA","Canberra", temperature$city_name)
temperature$city_name <- gsub("MELBOURNE","Melbourne", temperature$city_name)
temperature$city_name <- gsub("PERTH","Perth", temperature$city_name)
temperature$city_name <- gsub("SYDNEY","Sydney", temperature$city_name)


# Filter data from 1967 to 2018, for cities that have BOTH rainfall and temperature data
rainfall_1 <-  rainfall %>%
  filter(date >= "1970-01-01", date <= "2018-12-31") %>%
  filter(city_name == "Brisbane" | city_name == "Canberra" | city_name == "Melbourne" | city_name == "Perth" | city_name == "Sydney")

temp_1 <- temperature %>%
  filter(date >= "1970-01-01", date <= "201-12-31") %>%
  filter(city_name == "Brisbane" | city_name == "Canberra" | city_name == "Melbourne" | city_name == "Perth" | city_name == "Sydney")

```

Combine rainfall and temperature into one dataframe
```{r}
combined <- merge(rainfall_1, temp_1, by = c("city_name", "date"))
head(combined)
```

The ~ variables return the measurements by all combinations of var1 + var2, e.g. var1_1+var2_1, var1_2+var2_1, var1_1+var2_2, var1_2+var2_2. So, for individual variables where you want the measurements across all levels of the others, keep them separate.

```{r}

summaryBy(temperature ~ temp_type + city_name, data = combined,
  FUN = function(x) { c(average = mean(x, na.rm = T), standard_deviation = sd(x, na.rm = T), maximum = max(x, na.rm = T), minimum = min(x, na.rm = T)) } )

summaryBy(rainfall ~ city_name, data = combined,
  FUN = function(x) { c(average = mean(x, na.rm = T), standard_deviation = sd(x, na.rm = T), maximum = max(x, na.rm = T), minimum = min(x, na.rm = T)) } )

summaryBy(rainfall ~ month, data = combined,
  FUN = function(x) { c(average = mean(x, na.rm = T), standard_deviation = sd(x, na.rm = T), maximum = max(x, na.rm = T), minimum = min(x, na.rm = T)) } )

summaryBy(temperature ~ month + temp_type, data = combined,
  FUN = function(x) { c(average = mean(x, na.rm = T), standard_deviation = sd(x, na.rm = T), maximum = max(x, na.rm = T), minimum = min(x, na.rm = T)) } )

summaryBy(rainfall ~ year, data = combined,
  FUN = function(x) { c(average = mean(x, na.rm = T), standard_deviation = sd(x, na.rm = T), maximum = max(x, na.rm = T), minimum = min(x, na.rm = T)) } )

summaryBy(temperature ~ year + temp_type, data = combined,
  FUN = function(x) { c(average = mean(x, na.rm = T), standard_deviation = sd(x, na.rm = T), maximum = max(x, na.rm = T), minimum = min(x, na.rm = T)) } )


```

___Max and Min made into their own columns with temperature values and charting both rainfall and temperature values monthly___
```{r}
combined$date_monthly <- as.Date(paste(combined$year,"-",combined$month,"-",1, sep = "")) #makes charting the dates by month easier
combined$date_yearly <- as.Date(paste(combined$year,"-",1,"-",1, sep = ""))#makes charting the dates on the x-axis by year easier


combined_wider <- na.omit(pivot_wider(data=combined, names_from = temp_type, values_from = temperature))
names(combined_wider)[names(combined_wider) == "max"] <- "max_temperature"
names(combined_wider)[names(combined_wider) == "min"] <- "min_temperature"

```

___Timeline of Rainfall, Max Temperature, and Min Temperature for each Australian City___
```{r}
#Monthly Average Timeline
combined_avg_rt <- aggregate(. ~city_name+date_monthly,data = combined_wider[, c("rainfall","max_temperature","min_temperature","city_name","date_monthly")], mean)

p1<-ggplot(data = combined_avg_rt) +
  geom_bar(mapping = aes(y = rainfall, x = date_monthly),size=0.25, colour="NA", fill="dodgerblue",stat="identity")+
  geom_point(mapping = aes(y=min_temperature/0.5, x = date_monthly),size=0.05,alpha=0.75, colour="black") +
  geom_point(mapping = aes(y=max_temperature/0.5, x = date_monthly),size=0.05,alpha=0.75, colour="red") +
  scale_y_continuous(name = ("Rainfall (blue)"), limit=c(-5,65),sec.axis = sec_axis(~.*0.5,name="Temperature (Max=red, Min=black)"))+
  facet_grid(rows = vars(city_name))+
  scale_x_date(date_breaks = "years" , date_labels = "%Y")+
labs(x="Year",title = "Average Monthly Rainfall and Max/Min Temperatures")
p1+theme(axis.text.x = element_text(angle = 90))


#Yearly Average Timeline
combined_avg_rt <- aggregate(. ~city_name+date_yearly,data = combined_wider[, c("rainfall","max_temperature","min_temperature","city_name","date_yearly")], mean)

p1<-ggplot(data = combined_avg_rt) +
  geom_bar(mapping = aes(y = rainfall, x = date_yearly),size=0.05, colour="NA", fill="dodgerblue", stat="identity")+
  geom_point(mapping = aes(y=min_temperature/0.75, x = date_yearly),size=0.05,alpha=0.75, colour="black") +
  geom_point(mapping = aes(y=max_temperature/0.75, x = date_yearly),size=0.05,alpha=0.75, colour="red") +
  scale_y_continuous(name = ("Rainfall (blue)"), limit=c(-5,65),sec.axis = sec_axis(~.*0.75,name="Temperature (Max=red, Min=black)"))+
  facet_grid(rows = vars(city_name))+
  scale_x_date(date_breaks = "years" , date_labels = "%Y")+
labs(x="Year",title = "Average Monthly Rainfall and Max/Min Temperatures")
p1+theme(axis.text.x = element_text(angle = 90))
```
NOTE: Perth and Sydney have the only complete timelines to about 1970. Canberra only goes as far back as about 2008. Melbourne covers 1970 to 1993 and 1999-2018, and Brisbane covers 1972-1994 and 1999-2018.


___Find which time periods (by year at least) have all of the combined data for each city for each time point (besides Canberra)___
```{r}
combined_wider_1 <- na.omit(combined_wider)
intsct1 <- intersect(unique(combined_wider_1[combined_wider_1$city_name=="Perth","date_yearly"]),unique(combined_wider_1[combined_wider_1$city_name=="Sydney","date_yearly"]))

intsct2 <- intersect(unique(combined_wider_1[combined_wider_1$city_name=="Brisbane","date_yearly"]),unique(combined_wider_1[combined_wider_1$city_name=="Melbourne","date_yearly"]))

intersected_years<-intersect(intsct2,intsct1)

temp_var<-as.data.frame(diff(as.numeric(intersected_years$date_yearly)),col.names="values")
colnames(temp_var)<-"values"
ind_gap <- which.max(temp_var$values) #largest value will be the year the first period ends. The value indexed after that (ind_gap+1) is start of next period

print(paste("Period 1: ",substr(intersected_years$date_yearly[1],start=1,stop=4),"-",substr(intersected_years$date_yearly[ind_gap],start=1,stop=4),sep=""))
print(paste("Period 2: ",substr(intersected_years$date_yearly[ind_gap+1],start=1,stop=4),"-",substr(tail(intersected_years$date_yearly, n=1),start=1,stop=4),sep=""))
```
So we can either test Melbourne, Perth, Sydney, and Brisbane for these two time periods OR we can just take Sydney and Perth for 1970-2018. Perth and Sydney are on opposite sides of the continent (east and west coasts respectively). Brisbane is more north on the east coast and Melbourne is furthest south on othe east coast (Sydney is between those cities on the east coast.

Get rid of this chunk below?
```{r}
#To use date, need to use as.numeric(date) 
### RAINFALL BY MONTH
combined_wider$month <- as.numeric(combined_wider$month) #had to coerce to a factor
combined_wider$year <- as.numeric(combined_wider$year) #had to coerce to a factor
combined_wider$city_name <- as.factor(combined_wider$city_name) #had to coerce to a factor

#==========We can eliminate the rest of this block of code below if we just use a one-sample Kolmogorov-Smirnov test or the Anderson-Darling test (Anderson-Darling might be a more appropriate one to use)
#Need to reduce each city (and remove Canberra) to make the total dataframe less than 5000 overall (but roughly equal amounts for each individual cities)
reduced_sizes_overall <- combined_wider %>%
  filter(city_name != "Canberra") %>%
  slice(seq(1, n(), by = 2)) #Have to reduce to at least 5000 observations in order to be used for Shapiro-Wilk tests
reduced_sizes_overall %>% count(city_name)

#Need to reduce each city (and remove Canberra) to less than 5000 for each individual city for Shapiro-Wilk test
reduced_sizes_each_city <- combined_wider %>%
  filter(city_name != "Canberra") %>%
  group_by(city_name) %>%
  slice(seq(1, n(), by = 2)) #Have to reduce to at least 5000 observations in order to be used for normality tests
reduced_sizes_each_city %>% count(city_name)
```

#NORMALITY, HOV, AND ANOVA
Rather than continously call the same several lines of code over and over and over, I'm going to make a function instead that I can use several times instead to reduce the overall lines of code and save everyone (especially myself) some sanity
```{r}
Run_Normality_HOV_ANOVA_LinearReg_LinearReg<-function(y_input,factor_input,dataframe_name){
model <- lm(y_input ~ factor_input,data=dataframe_name)
ols_plot_resid_qq(model)
ols_plot_resid_fit(model)
#Anderson-Darling Normality Test
ad_out<-ad.test(model$residuals) #Normality
print(ad_out)
cat("\n-------------------------------\n\n")

#HOV Test: Brown-Forsythe test
res <- bf.test(rainfall ~ city_name, data = dataframe_name)

cat("\n-------------------------------\n-\n-\n-\n")
#ANOVA Table
anova(model)

#Significance of Slope Linear Regression
summary(model)
}
```
NOTE: Input has to be put in as
> Run_Normality_HOV_ANOVA_LinearReg(dataframe$response_columnname,dataframe$group_columnname,dataframe)

___Interactions with Cities of Sydney and Perth___
```{r}
combined_wider$month <- as.numeric(combined_wider$month) 
combined_wider$year <- as.numeric(combined_wider$year) 
combined_wider$city_name <- as.factor(combined_wider$city_name) #had to coerce to a factor

#=== Looking at all cities from all times ===

#Rainfall and City
Run_Normality_HOV_ANOVA_LinearReg_LinearReg(combined_wider$rainfall,combined_wider$city_name,combined_wider)

#Max Temperature and City
Run_Normality_HOV_ANOVA_LinearReg_LinearReg(combined_wider$max_temperature,combined_wider$city_name,combined_wider)

#Min Temperature and City
Run_Normality_HOV_ANOVA_LinearReg_LinearReg(combined_wider$min_temperature,combined_wider$city_name,combined_wider)

#==== Looking at all cities from 2008 - 2018====
Current_period <- combined_wider %>% filter(date >= "2008-01-01", date <= "2018-12-31")
#Rainfall and Year 
Run_Normality_HOV_ANOVA_LinearReg(Current_period$rainfall,Current_period$year,Current_period)

#Max Temperature and Years 
Run_Normality_HOV_ANOVA_LinearReg(Current_period$max_temperature,Current_period$year,Current_period)

#Max Temperature and Year 
Run_Normality_HOV_ANOVA_LinearReg(Current_period$min_temperature,Current_period$year,Current_period)



#==== Looking at Sydney and Perth only from 1970-2018 ====
sydney_and_perth_only <- combined_wider %>% filter(city_name=="Sydney" | city_name=="Perth")
#Rainfall and Year 
Run_Normality_HOV_ANOVA_LinearReg(sydney_and_perth_only$rainfall,sydney_and_perth_only$year,sydney_and_perth_only)

#Max Temperature and Years 
Run_Normality_HOV_ANOVA_LinearReg(sydney_and_perth_only$max_temperature,sydney_and_perth_only$year,sydney_and_perth_only)

#Max Temperature and Year 
Run_Normality_HOV_ANOVA_LinearReg(sydney_and_perth_only$min_temperature,sydney_and_perth_only$year,sydney_and_perth_only)


```

What graphs do we want to keep from here?
```{r}
ggplot(data = combined) +
  geom_point(mapping = aes(x = temperature, y = rainfall, color = temp_type))
  #facet_grid(city_name~year)

ggplot(data = combined) +
  geom_col(mapping = aes(x = year, y = rainfall))

ggplot(data = combined) +
  geom_col(mapping = aes(x = year, y = temperature, color = temp_type))

ggplot(data = combined) +
  geom_col(mapping = aes(x = month, y = rainfall))

ggplot(data = combined) +
  geom_col(mapping = aes(x = month, y = temperature, color = temp_type))

ggplot(data = combined) +
  geom_col(mapping = aes(x = city_name, y = rainfall))
  #facet_grid(~year)

ggplot(data = combined) +
  geom_col(mapping = aes(x = month, y = temperature, color = temp_type))
  #facet_grid(~city_name)

```






